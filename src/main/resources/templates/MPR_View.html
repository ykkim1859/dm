<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>상품 페이지 상세</title>
    <!-- META TAG -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="SDK"/>
    <meta name="description" content="특별한 술을 체험"/>
    <meta name="date" content="2022월06월17일"/>
    <!-- CSS, FONT -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nothing+You+Could+Do" rel="stylesheet">
    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="css/jquery.timepicker.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body	>
<!-- navigation : start -->
<nav th:replace="nav.html :: nav"></nav>
<!-- navigation : end -->
<!-- background : start -->
<section class="bg-wrap"></section>
<!-- background : end -->
<section class="ftco-section">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <img th:src="@{/PRFILE/{pr}(pr=${product.PRFILENAME})}" style="width: 100%;"/>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6">
                        <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0; color: #fac564;" th:text="${product.PRNAME}"></p>
                        <p th:text="${product.PRCONTENT}"></p>
                        <input type="hidden" id="PRNUM" th:value="${product.PRNUM}"/>
                    	<input type="hidden" id="PRTNUM" th:value="${product.PRTNUM}"/>
                    	<input type="hidden" id="RMID" th:value="${session.loginId}"/>
                        수량 :
                        <select id="CACOUNT">
                        	<option value="1">1</option>
                        	<option value="2">2</option>
                        	<option value="3">3</option>
                        	<option value="4">4</option>
                        	<option value="5">5</option>
                        	<option value="6">6</option>
                        	<option value="7">7</option>
                        	<option value="8">8</option>
                        	<option value="9">9</option>
                        	<option value="10">10</option>
                        </select><br />
                        금액 : <input type="text" id="CAPRICE" th:value="${product.PRPRICE}"/>
                    	<button class="btn btn-primary py-3 px-5 mt-5" id="cartBtn">장바구니</button>
                        <a class="btn btn-primary py-3 px-5 mt-5" th:href="@{P_WriteForm(CAMID=${session.loginId})}">구매하기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="ftco-section" style="padding-top: 0;">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <img src="/images/banner.png"/> <br/><br/><br/>
                <p>
                    <span style="font-size: 1.15rem; font-weight: 600;">교환 및 반품 주소</span> <br/>
                    - [13919] 경기도 안양시 동안구 동안로 256 드숑마숑 주식회사 <br/> <br/>

                    <span style="font-size: 1.15rem; font-weight: 600;">교환 및 반품이 가능한 경우</span> <br/>
                    - 포장을 개봉하였거나 포장이 훼손되어 상품가치가 상실된 경우에는 교환/반품이 불가능합니다. <br/>
                    - 공급받으신 상품 및 용역의 내용이 표시.광고 내용과 다르거나 다르게 이행된 경우에는 공급받은 날로부터 3개월이내, 그사실을 알게 된 날로부터 30일이내에 가능합니다. <br/>
                    <br/>

                    <span style="font-size: 1.15rem; font-weight: 600;">교환 및 반품이 불가능한 경우</span><br/>
                    - 고객님의 책임 있는 사유로 상품등이 멸실 또는 훼손된 경우. 단, 상품의 내용을 확인하기 위하여 <br/>
                    포장 등을 훼손한 경우는 제외 <br/>
                    - 포장을 개봉하였거나 포장이 훼손되어 상품가치가 상실된 경우 <br/>
                    (예 : 가전제품, 식품, 음반 등, 단 액정화면이 부착된 노트북, LCD모니터, 디지털 카메라 등의 불량화소에 <br/>
                    따른 반품/교환은 제조사 기준에 따릅니다.) <br/>
                    - 고객님의 사용 또는 일부 소비에 의하여 상품의 가치가 현저히 감소한 경우 단, 화장품등의 경우 시용제품을 제공한 경우에 한 합니다. <br/>
                    - 시간의 경과에 의하여 재판매가 곤란할 정도로 상품등의 가치가 현저히 감소한 경우 <br/>
                    - 복제가 가능한 상품등의 포장을 훼손한 경우 <br/><br/> <br/>

                    ※ 고객님의 마음이 바뀌어 교환, 반품을 하실 경우 상품반송 비용은 고객님께서 부담하셔야 합니다. <br/>
                    (색상 교환, 사이즈 교환 등 포함) <br/> <br/>

                    <span style="font-size: 1.15rem; font-weight: 600;">환불안내</span> <br/> <br/>

                    환불시 반품 확인여부를 확인한 후 3영업일 이내에 결제 금액을 환불해 드립니다. <br/>
                </p>
            </div>
        </div>
    </div>
</section>
<section class="ftco-section" style="padding-top: 0;">
    <div class="container">
        <div class="row" style="margin-top: 3%;">
            <div id="reviewArea" class="col-md-12"></div>
        </div>
        <div class="row" style="margin-top: 3%;">
            <div class="col-md-12 form-group">
                <textarea id="RCONTENT" style="font-size: 15px;" class="form-control" rows="5" cols="20"></textarea>
                <button id="RBTN" style="margin-top: 3%; position: absolute; right: 0;" class="btn btn-primary">상품평 입력</button>
            </div>
        </div>
    </div>
</section>
<!-- footer : start -->
<footer th:replace="footer.html :: footer"></footer>
<!-- footer : end -->
<script src="js/jquery.min.js"></script>
<script src="js/jquery-migrate-3.0.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.easing.1.3.js"></script>
<script src="js/jquery.waypoints.min.js"></script>
<script src="js/jquery.stellar.min.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/aos.js"></script>
<script src="js/jquery.animateNumber.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/jquery.timepicker.min.js"></script>
<script src="js/scrollax.min.js"></script>
<script src="js/main.js"></script>
<script>
    // jquery 실행
    $(document).ready(function () {
    	// 카트 담기
    	$("#cartBtn").click(function(){
    		var CAMID = $("#RMID").val();
    		var CAPRNUM = $("#PRNUM").val();
    		var CAPRTNUM = $("#PRTNUM").val();
    		var CAPRICE = $("#CAPRICE").val();
    		var CACOUNT = $("#CACOUNT").val();
    		console.log(CAPRICE);
    		$.ajax({
                type: "POST",
                url: "CA_Write",
                data: {"CAPRNUM": CAPRNUM, "CAMID":CAMID, "CAPRTNUM":CAPRTNUM, "CAPRICE":CAPRICE, "CACOUNT":CACOUNT},
                dataType: "json",
                success: function () {
                    alert("장바구니에 담겼습니다.");
                },
                error: function () {
                    // 통신 실패 시 실행
                    alert('실패!');
                }
            });
    	});
        var RPRNUM = $("#PRNUM").val();
        // 상품평 목록 조회
        $.ajax({
            type: "POST",
            url: "R_List",
            data: {"RPRNUM": RPRNUM},
            dataType: "json",
            success: function (reviewlist) {
                R_List(reviewlist);
            },
            error: function () {
                // 통신 실패 시 실행
                alert('상품평 목록 조회 실패!');
            }
        });
        // RBTN 버튼 클릭 시 상품평 작성
        $("#RBTN").click(function () {
            var RMID = $("#RMID").val();
            var RPRTNUM = $("#PRTNUM").val();
            var RCONTENT = $('#RCONTENT').val();
            var RPRNUM = $("#PRNUM").val();
            // RMID(로그인 한 아이디)가 빈 값이면
            if (RMID == '') {
                alert('로그인 후 이용해 주세요.');
                location.href = "M_LoginForm";
                $("#RCONTENT").val("");
            } else {
                // 상품평 입력
                $.ajax({
                    type: "POST",
                    url: "R_Write",
                    data: {"RMID": RMID, "RPRTNUM": RPRTNUM, "RPRNUM": RPRNUM, "RCONTENT": RCONTENT},
                    dataType: "json",
                    success: function (reviewlist) {
                        R_List(reviewlist);
                        $('#RCONTENT').val("");
                    },
                    error: function () {
                        // 통신 실패 시 실행
                        alert('상품평 작성 실패!');
                    }
                });
            }
        });
    });

    // 수정 버튼 클릭 시 상품평 수정
    function R_Modify(RNUM, RPRNUM) {
        var check = confirm('상품평을 수정 하시겠습니까?');
        var RCONTENT = $('#RCONTENT').val();
        if (check) {
            $.ajax({
                type: "POST",
                url: "/R_Modify",
                data: {"RNUM": RNUM, "RPRNUM": RPRNUM, "RCONTENT": RCONTENT},
                dataType: "json",
                success: function (reviewlist) {
                    R_List(reviewlist);
                },
                error: function () {
                    // 통신 실패 시 실행
                    alert('상품평 수정 실패!');
                }
            });
        }
    }

    // 상품평 목록 조회
    function R_List(reviewlist) {
        var login = $("#RMID").val();
        var output = "";
        // output 변수에 계속 추가 : (+=) 사용
        output += "<table class='rtable'>";
        output += "<tr>";
        output += "<th>작성자</th>";
        output += "<th>작성일</th>";
        output += "<th>내용</th>";
        output += "<th></th>";
        output += "<th></th>";
        output += "</tr>";
        output += "<colgroup>";
        output += "<col width='20%'>";
        output += "<col width='30%'>";
        output += "<col width='50%'>";
        output += "<colgroup>";
        console.log(reviewlist);
        // 상품평의 갯수(list라는 이름의 배열의 길이)만큼 반복문 실행(for문)
        for (var i in reviewlist) {
            output += "<tr>";
            output += "<td>" + reviewlist[i].rmid + "</td>";
            // 소문자로 가져와야 한다.('rmid')
            output += "<td>" + reviewlist[i].rdate + "</td>";
            output += "<td>" + reviewlist[i].rcontent + "</td>";
            if (reviewlist[i].rmid == login) {
                output += "<td><button id='R_Modify' onclick='R_Modify(" + reviewlist[i].rnum + ", " + reviewlist[i].rprnum + ")'>수정</button></td>";
            }
            if (reviewlist[i].rmid == login || login == 'admin') {
                output += "<td><button onclick='R_Delete(" + reviewlist[i].rnum + ", " + reviewlist[i].rprnum + ")'>삭제</button></td>";
            }
            output += "</tr>";
        }
        output += "</table>";
        // div 영역 선언 : id가 reviewArea라는 div
        var reviewArea = document.getElementById('reviewArea');
        // reviewArea에 output 값 대입
        reviewArea.innerHTML = output;
    }

    // 상품평 삭제 함수
    // RNUM과 RPRNUM을 가지고 해당 함수 실행
    function R_Delete(RNUM, RPRNUM) {
        // 해당 내용을 삭제할 지 여부를 묻고 확인을 누르면 true, 취소를 누르면 false 값이 check에 대입
        var check = confirm('상품평 삭제 하시겠습니까?');
        // 만약 check 가 true면 실행
        if (check) {
            $.ajax({
                type: "POST",
                url: "R_Delete",
                data: {"RNUM": RNUM, "RPRNUM": RPRNUM},
                dataType: "json",
                success: function (reviewlist) {
                    R_List(reviewlist);
                },
                error: function () {
                    alert('상품평 삭제 실패!');
                }
            });
        }
    }
</script>
</body>
</html>